{% extends 'base.html' %}
{% block content %}
<h2>–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤</h2>
<div id="logs-container">
  <aside class="log-sidebar">
    <div class="log-group">
      <h3>üïë –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ª–æ–≥–∞</h3>
      <ul id="latest-log-list" class="log-list"><li>–ó–∞–≥—Ä—É–∑–∫–∞...</li></ul>
    </div>
  
    <div class="log-group">
     <h3>üìÅ –í—Å–µ —Ñ–∞–π–ª—ã   <button  class="logsbutton" id="download-all-btn" style=" position: relative;
  left: 84px;">–°–∫–∞—á–∞—Ç—å –≤—Å—ë ZIP</button> </h3>
      
  
      <!-- –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div id="filters" style="margin-bottom: 1rem;">
        <label><input type="checkbox" value="*all" checked>–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</label>
        <label><input type="checkbox" value="acep" checked> –ë–∞–∑–æ–≤—ã–µ</label>
        <label><input type="checkbox" value="acceptance" checked> –†–∞—Å—à–∏—Ä–µ–Ω—ã–µ –ë–∞–∑–æ–≤—ã–µ</label>
        <label><input type="checkbox" value="Regression" checked> –ü–æ–ª–Ω—ã–µ</label>
        <label><input type="checkbox" value="regres" checked> –†–∞—Å—à–∏—Ä–µ–Ω—ã–µ –ü–æ–ª–Ω—ã–µ</label>
        <label><input type="checkbox" value=".txt" checked> .txt</label>
        <label><input type="checkbox" value=".jpg" checked> .jpg</label>
      </div>
  
      <ul id="file-list" class="log-list"><li>–ó–∞–≥—Ä—É–∑–∫–∞...</li></ul>
    </div>
  </aside>
  
  

  <section class="viewer">
    <div class="viewer-header">
      <h3 id="current-file">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</h3>
      <div style="display: flex; gap: 0.5rem;">
        <button  class="logsbutton" id="download-btn" disabled >–°–∫–∞—á–∞—Ç—å</button>
        <button  class="logsbutton" id="delete-btn" disabled style="background:#dc3545;">–£–¥–∞–ª–∏—Ç—å</button>
        
      </div>
    </div>
    <pre id="file-content">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>
  </section>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const listEl = document.getElementById('file-list');
    const latestListEl = document.getElementById('latest-log-list');
    const contentEl = document.getElementById('file-content');
    const titleEl = document.getElementById('current-file');
    const btnDownload = document.getElementById('download-btn');
    const btnDelete = document.getElementById('delete-btn');
    const btnDownloadAll = document.getElementById('download-all-btn');
    const filterEls = document.querySelectorAll('#filters input[type="checkbox"]');
    let allFiles = [];
    let currentFile = '';
  
    function extractTimestamp(name) {
      const match = name.match(/(\d{8})_(\d{6})/);
      if (!match) return null;
      const [_, date, time] = match;
      return new Date(
        date.slice(0, 4),
        date.slice(4, 6) - 1,
        date.slice(6, 8),
        time.slice(0, 2),
        time.slice(2, 4),
        time.slice(4, 6)
      ).getTime();
    }
  
    fetch('/api/logs')
      .then(r => r.json())
      .then(data => {
        allFiles = data.files.map(f => ({
          name: f,
          time: extractTimestamp(f) || 0
        }));
  
        renderLists();
      });
  
    function renderLists() {
      const activeFilters = Array.from(filterEls)
        .filter(el => el.checked)
        .map(el => el.value.toLowerCase());
  
      listEl.innerHTML = '';
      latestListEl.innerHTML = '';
  
      if (!allFiles.length) {
        listEl.innerHTML = '<li>–ù–µ—Ç –ª–æ–≥–æ–≤</li>';
        return;
      }
  
      const topFiles = [...allFiles]
        .filter(f => f.time)
        .sort((a, b) => b.time - a.time)
        .slice(0, 3);
  
      const restFiles = allFiles.filter(f => !topFiles.includes(f));
  
      const append = (el, fileObj) => {
        const li = document.createElement('li');
        li.textContent = fileObj.name;
        li.title = fileObj.name;
        li.addEventListener('click', () => loadLog(fileObj.name));
        el.appendChild(li);
      };
  
      topFiles.forEach(f => append(latestListEl, f));
  
      restFiles.forEach(f => {
        const lower = f.name.toLowerCase();
        const matchesAll = activeFilters.includes('*all');
        const matchesFiltered = activeFilters.some(filt => lower.includes(filt));
        if (matchesAll || matchesFiltered) append(listEl, f);
      });
    }
  
    filterEls.forEach(el => el.addEventListener('change', renderLists));
  
    function loadLog(fname) {
      currentFile = fname;
      titleEl.textContent = fname;
      contentEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      btnDownload.disabled = false;
      btnDelete.disabled = false;
  
      fetch(`/api/logs/${encodeURIComponent(fname)}`)
        .then(r => r.json())
        .then(data => {
          if (data.type === 'image') {
            contentEl.innerHTML = `<img src="${data.url}" style="max-width:100%; max-height:70vh; border:1px solid #ccc; border-radius:4px;" alt="${data.filename}">`;
          } else {
            contentEl.textContent = data.content || '(–ø—É—Å—Ç–æ–π —Ñ–∞–π–ª)';
          }
        })
        .catch(() => {
          contentEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
          btnDownload.disabled = true;
          btnDelete.disabled = true;
        });
    }
  
    btnDownload.addEventListener('click', () => {
      if (!currentFile) return;
      window.location.href = `/api/logs/download/${encodeURIComponent(currentFile)}`;
    });
  
    btnDelete.addEventListener('click', () => {
      if (!currentFile) return;
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª ${currentFile}?`)) return;
  
      fetch(`/api/logs/delete/${encodeURIComponent(currentFile)}`, {
        method: 'DELETE'
      })
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            alert('–§–∞–π–ª —É–¥–∞–ª—ë–Ω');
            renderLists();
            contentEl.textContent = '–§–∞–π–ª —É–¥–∞–ª—ë–Ω.';
            titleEl.textContent = '–§–∞–π–ª —É–¥–∞–ª—ë–Ω';
            btnDelete.disabled = true;
            btnDownload.disabled = true;
          } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + res.error);
          }
        })
        .catch(() => alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞'));
    });
  
    btnDownloadAll.addEventListener('click', () => {
      window.location.href = '/api/logs/download_all';
    });
  });
  </script>
  
  
{% endblock %}
