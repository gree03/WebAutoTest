{% extends 'base.html' %}
{% block content %}
<h2>–ü—Ä–æ—à–∏–≤–∫–∏</h2>

<div class="firmware-container">
  <!-- –õ–µ–≤—ã–π –±–ª–æ–∫: –≤–µ—Ä—Å–∏–∏ -->
  <aside class="sidebarversion">
    <div class="log-group">
      <h3>üî¢ –í–µ—Ä—Å–∏–∏</h3>
      <div class="log-group">
        <input type="text" id="new-version-input" placeholder="–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è" />
        <button id="create-version-btn">–°–æ–∑–¥–∞—Ç—å –≤–µ—Ä—Å–∏—é</button>
      </div>
      <ul id="version-list" class="log-list">
        <li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
      </ul>
    </div>
  </aside>

  <!-- –ü—Ä–∞–≤—ã–π –±–ª–æ–∫ -->
  <main class="content">
    <!-- –ü–∞–Ω–µ–ª—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
    <div class="viewer">
      <div class="viewer-header">
        <div>
          <h3 id="current-file">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</h3>
          <pre id="file-info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>
        </div>
        <div>
          <button id="download-btn" disabled>–°–∫–∞—á–∞—Ç—å</button>
          <button id="delete-btn" disabled style="background:#dc3545;">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      <!-- –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
      <div class="viewer-body">
        <img id="image-preview" alt="Preview" />
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ -->
    <div class="log-group">
      <h3>üìÑ –§–∞–π–ª—ã</h3>
      <ul id="file-list" class="log-list">
        <li>–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é</li>
      </ul>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ (–±–µ–∑ select) -->
    <div class="log-group">
      <h3>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ –≤–µ—Ä—Å–∏—é</h3>
      <input type="file" id="upload-file" />
      <button id="upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
  </main>
</div>

<style>
.firmware-container {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

.sidebarversion {
  width: 250px;
}

.log-list li.active {
  background-color: #e0f7fa;
}

.viewer {
  margin-bottom: 20px;
}

.viewer-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  flex-wrap: wrap;
}

.viewer-body {
  margin-top: 10px;
  /* –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É */
}

#image-preview {
  display: none;
  max-width: 100%;
  max-height: 400px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const versionList    = document.getElementById('version-list');
  const fileList       = document.getElementById('file-list');
  const uploadInput    = document.getElementById('upload-file');
  const uploadBtn      = document.getElementById('upload-btn');
  const newVersionInput= document.getElementById('new-version-input');
  const createVersionBtn = document.getElementById('create-version-btn');
  const currentFileTitle = document.getElementById('current-file');
  const fileInfo       = document.getElementById('file-info');
  const downloadBtn    = document.getElementById('download-btn');
  const deleteBtn      = document.getElementById('delete-btn');
  const imagePreview   = document.getElementById('image-preview');

  let currentVersion = null;
  let currentFile    = null;

  function loadVersions() {
    fetch('/api/firmware/versions')
      .then(r => r.json())
      .then(data => {
        versionList.innerHTML = '';
        data.versions.forEach(v => {
          const li = document.createElement('li');
          li.textContent = v;
          li.addEventListener('click', () => {
            versionList.querySelectorAll('li').forEach(el => el.classList.remove('active'));
            li.classList.add('active');
            loadFiles(v);
          });
          versionList.appendChild(li);
        });
        if (!data.versions.length) {
          versionList.innerHTML = '<li>–ù–µ—Ç –≤–µ—Ä—Å–∏–π</li>';
        }
      });
  }

  createVersionBtn.addEventListener('click', () => {
    const v = newVersionInput.value.trim();
    if (!v) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤–µ—Ä—Å–∏–∏');
    fetch('/api/firmware/versions/create', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({version: v})
    })
    .then(r => r.json().then(body => ({ok: r.ok, body})))
    .then(({ok, body}) => {
      if (ok) {
        alert('–°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ä—Å–∏—è ' + body.version);
        newVersionInput.value = '';
        loadVersions();
      } else {
        alert(body.error);
      }
    });
  });

  function loadFiles(version) {
    currentVersion = version;
    currentFileTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª';
    fileInfo.textContent = '';
    downloadBtn.disabled = true;
    deleteBtn.disabled = true;
    imagePreview.style.display = 'none';

    fetch(`/api/firmware/${encodeURIComponent(version)}`)
      .then(r => r.json())
      .then(data => {
        fileList.innerHTML = '';
        data.files.forEach(f => {
          const li = document.createElement('li');
          li.textContent = f;
          li.addEventListener('click', () => selectFile(f));
          fileList.appendChild(li);
        });
        if (!data.files.length) {
          fileList.innerHTML = '<li>–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</li>';
        }
      });
  }

  function selectFile(filename) {
    currentFile = filename;
    currentFileTitle.textContent = filename;
    fileInfo.textContent = `–í–µ—Ä—Å–∏—è: ${currentVersion}\n–§–∞–π–ª: ${filename}`;
    downloadBtn.disabled = false;
    deleteBtn.disabled = false;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ PNG
    if (filename.toLowerCase().endsWith('.png')) {
      imagePreview.src = `/firmware/${encodeURIComponent(currentVersion)}/${encodeURIComponent(filename)}`;
      imagePreview.style.display = 'block';
    } else {
      imagePreview.style.display = 'none';
    }
  }

  downloadBtn.addEventListener('click', () => {
    if (currentVersion && currentFile) {
      window.location.href =
        `/firmware/${encodeURIComponent(currentVersion)}/${encodeURIComponent(currentFile)}`;
    }
  });

  deleteBtn.addEventListener('click', () => {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${currentFile}?`)) return;
    fetch(
      `/api/firmware/${encodeURIComponent(currentVersion)}/delete/${encodeURIComponent(currentFile)}`, 
      { method: 'DELETE' }
    )
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        alert('–£–¥–∞–ª–µ–Ω–æ');
        loadFiles(currentVersion);
      } else {
        alert(res.error);
      }
    });
  });

  uploadBtn.addEventListener('click', () => {
    if (!currentVersion) return alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é');
    const file = uploadInput.files[0];
    if (!file) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
    const form = new FormData();
    form.append('file', file);

    fetch(`/api/firmware/${encodeURIComponent(currentVersion)}/upload`, {
      method: 'POST',
      body: form
    })
    .then(r => r.json())
    .then(res => {
      if (res.success) {
        alert('–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ' + res.filename);
        loadFiles(currentVersion);
      } else {
        alert(res.error);
      }
    });
  });

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  loadVersions();
});
</script>

{% endblock %}
